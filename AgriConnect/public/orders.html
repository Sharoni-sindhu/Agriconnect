<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>My Orders</title>
 <style>
    /* üåø Animated Gradient Background */
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
      background: linear-gradient(120deg, #e8f5e9, #f1f8e9, #dcedc8);
      background-size: 300% 300%;
      animation: gradientFlow 12s ease infinite;
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* üçÉ Floating Leaf Animation */
    .leaves {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }

    .leaf {
      position: absolute;
      width: 30px;
      height: 30px;
      background-image: url('https://cdn-icons-png.flaticon.com/512/415/415733.png');
      background-size: cover;
      opacity: 0.8;
      animation: fall 10s linear infinite;
    }

    @keyframes fall {
      0% {
        transform: translateY(-10vh) rotate(0deg);
        opacity: 0;
      }
      10% { opacity: 1; }
      100% {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Random leaf positions */
    .leaf:nth-child(1) { left: 10%; animation-delay: 0s; }
    .leaf:nth-child(2) { left: 25%; animation-delay: 2s; width: 25px; height: 25px; }
    .leaf:nth-child(3) { left: 50%; animation-delay: 4s; width: 35px; height: 35px; }
    .leaf:nth-child(4) { left: 70%; animation-delay: 1s; width: 28px; height: 28px; }
    .leaf:nth-child(5) { left: 85%; animation-delay: 3s; width: 24px; height: 24px; }

    /* üå≥ NAVBAR */
    .navbar {
      background: rgba(46, 125, 50, 0.95);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .navbar h1 {
      color: #fff;
      font-size: 22px;
      margin: 0;
      letter-spacing: 1px;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 25px;
      margin: 0;
      padding: 0;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease, transform 0.2s ease;
    }

    .nav-links a:hover {
      color: #ffd54f;
      transform: scale(1.05);
    }

    /* üå± CONTAINER */
    .container {
      max-width: 800px;
      margin: 60px auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(6px);
      position: relative;
      z-index: 5;
      animation: fadeIn 1.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      color: #2e7d32;
      font-size: 30px;
      margin-bottom: 30px;
      font-weight: 700;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* üîç FILTER BAR */
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .filter-bar input,
    .filter-bar select,
    .filter-bar button {
      padding: 12px 16px;
      border-radius: 25px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 14px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .filter-bar input {
      flex: 1;
      min-width: 220px;
    }

    .filter-bar button {
      background: #2e7d32;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .filter-bar button:hover {
      background: #256628;
      transform: scale(1.05);
    }

    /* üßæ TIMELINE */
    .timeline {
      position: relative;
      margin: 20px 0;
    }

    .timeline::before {
      content: "";
      position: absolute;
      left: 20px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, #a5d6a7, #66bb6a);
      border-radius: 2px;
    }

    /* üì¶ ORDER CARD */
    .order {
      background: #fff;
      margin: 20px 0 20px 60px;
      padding: 20px 25px;
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      position: relative;
      transition: all 0.3s ease;
      border-left: 6px solid #66bb6a;
    }

    .order:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(46, 125, 50, 0.25);
    }

    .order h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #2e7d32;
    }

    .order p {
      margin: 5px 0;
      font-size: 14px;
      color: #444;
    }

    .order small {
      display: block;
      margin-top: 8px;
      color: #777;
      font-size: 12px;
    }

    /* üîñ STATUS BADGES */
    .badge {
      display: inline-block;
      padding: 5px 12px;
      font-size: 12px;
      border-radius: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      text-decoration: none;
    }

    .badge.confirmed { background: #e8f5e9; color: #2e7d32; }
    .badge.pending { background: #fff3e0; color: #ef6c00; }
    .badge.delivered { background: #e3f2fd; color: #1565c0; }
    .badge.cancelled { background: #ffebee; color: #c62828; }

    /* ü™¥ ACTION BUTTONS */
    .action-btn {
      display: inline-block;
      margin-top: 8px;
      margin-right: 6px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 15px;
      text-decoration: none;
      transition: transform 0.2s ease;
    }

    .action-btn.email { background: #e8f5e9; color: #2e7d32; }
    .action-btn.call { background: #e3f2fd; color: #1565c0; }
    .action-btn:hover { transform: scale(1.05); }
  </style>
</head>

<body>

  <!-- üçÉ Floating Animated Background -->
  <div class="leaves">
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="leaf"></div>
    <div class="leaf"></div>
  </div>

  <!-- NAVBAR -->
  <nav class="navbar">
    <h1>üåø </h1>
    <ul class="nav-links">
      <li><a href="consumers.html">Home</a></li>
      <li><a href="buyers.html">Buy Products</a></li>
      <li><a href="#" id="logoutBtn">Logout</a></li>
    </ul>
  </nav>

  <!-- ORDERS LIST -->
  <div class="container">
    <h2 id="welcomeUser">üì¶ My Orders</h2>

    <!-- FILTER BAR -->
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="üîç Search by product or seller...">
      <select id="statusFilter">
        <option value="all">All Status</option>
        <option value="confirmed">Confirmed</option>
        <option value="pending">Pending</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <button id="sortToggle">‚¨Ü Sort by Latest</button>
    </div>

    <!-- TIMELINE -->
    <div id="ordersList" class="timeline"></div>
  </div>

  <script>
    // Load username from localStorage
    const username = localStorage.getItem("farmName");
    if (username) {
      document.getElementById("welcomeUser").textContent = "üì¶ My Orders ‚Äî Welcome, " + username;
    }

    // Fetch logged-in user from backend
    async function showUsername() {
      try {
        const res = await fetch("/session-user");
        const data = await res.json();
        if (data.loggedIn && data.name) {
          document.querySelector(".navbar h1").textContent = `üåø Welcome, ${data.name}`;
        }
      } catch (err) {
        console.error("Error fetching session user:", err);
      }
    }
    showUsername();

    // Logout button
    document.getElementById("logoutBtn").onclick = function () {
      localStorage.removeItem("farmName");
      window.location.href = "login.html";
    };

    let allOrders = [];
    let sortLatest = true;

    async function loadOrders() {
      try {
        const res = await fetch("/orders");
        const orders = await res.json();

        allOrders = Array.isArray(orders) ? orders : [];
        renderOrders(allOrders);
      } catch (err) {
        console.error("Error loading orders:", err);
      }
    }

    function renderOrders(orders) {
      const list = document.getElementById("ordersList");

      if (!orders.length) {
        list.innerHTML = "<p style='text-align:center; color:#888;'>No orders found.</p>";
        return;
      }

      const sorted = [...orders].sort((a, b) =>
        sortLatest ? new Date(b.createdAt) - new Date(a.createdAt)
          : new Date(a.createdAt) - new Date(b.createdAt)
      );

      list.innerHTML = sorted.map(o => {
        const productName = o.productName || o.product || o.name || "Unnamed Product";
        const sellerName = o.sellerName || "Unknown";
        const sellerEmail = o.sellerEmail && o.sellerEmail !== "Not Provided" ? o.sellerEmail : null;
        const sellerPhone = o.sellerPhone && o.sellerPhone !== "Not Provided" ? o.sellerPhone : null;
        const status = (o.status || "confirmed").toLowerCase();

        return `
          <div class="order">
            <span class="badge ${status}">${status.toUpperCase()}</span>
            <h3>${productName}</h3>
            <p><strong>Seller:</strong> ${sellerName}</p>
            <p><strong>Email:</strong> ${sellerEmail || "Not Provided"}</p>
            <p><strong>Phone:</strong> ${sellerPhone || "Not Provided"}</p>

            <div>
              ${sellerEmail ? `<a href="mailto:${sellerEmail}?subject=Inquiry about ${encodeURIComponent(productName)}" class="action-btn email">üìß Email Seller</a>` : ""}
              ${sellerPhone ? `<a href="tel:${sellerPhone}" class="action-btn call">üìû Call Seller</a>` : ""}
            </div>

            <small>üïí Ordered on: ${o.createdAt ? new Date(o.createdAt).toLocaleString() : "Unknown Date"}</small>
          </div>
        `;
      }).join("");
    }

    

    function applyFilters() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;

      const filtered = allOrders.filter(o => {
        const matchesSearch =
          (o.productName || "").toLowerCase().includes(query) ||
          (o.sellerName || "").toLowerCase().includes(query);
        const matchesStatus =
          status === "all" || (o.status || "confirmed").toLowerCase() === status;
        return matchesSearch && matchesStatus;
      });

      renderOrders(filtered);
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("statusFilter").addEventListener("change", applyFilters);
    document.getElementById("sortToggle").addEventListener("click", function () {
      sortLatest = !sortLatest;
      this.textContent = sortLatest ? "‚¨Ü Sort by Latest" : "‚¨á Sort by Oldest";
      applyFilters();
    });

    loadOrders();
  </script>
</body>
</html>
