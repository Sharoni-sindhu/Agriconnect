<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmers Dashboard | Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
  --primary: #6b4226;
  --secondary: #a3c14a;
  --accent: #fffaf0;
  --surface: #ffffff;
  --gray: #f2e8cf;
  --highlight: #ffb347;
  --shadow: 0 2px 12px rgba(107, 66, 38, 0.15);
}

/* üåà Animated gradient background */
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  min-height: 100vh;
  display: flex;
  color: #3b2f2f;
  background: linear-gradient(-45deg, #f9f5e3, #f6e3c5, #cdebb0, #f4f1ec);
  background-size: 400% 400%;
  animation: gradientShift 12s ease infinite;
  overflow-x: hidden;
  transition: 0.3s;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Sidebar */
aside.sidebar {
  width: 250px;
  background: rgba(107, 66, 38, 0.95);
  color: #fffaf0;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 24px;
  box-shadow: 4px 0 15px rgba(0,0,0,0.1);
  backdrop-filter: blur(6px);
  border-right: 3px solid var(--secondary);
  animation: fadeInLeft 1s ease;
}

@keyframes fadeInLeft {
  from { transform: translateX(-40px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

aside.sidebar h2 {
  margin-bottom: 24px;
  color: var(--highlight);
  text-shadow: 0 0 6px rgba(255,180,70,0.7);
}

aside.sidebar a {
  display: block;
  padding: 12px 16px;
  color: #fffaf0;
  text-decoration: none;
  font-weight: 500;
  margin-bottom: 6px;
  border-radius: 6px;
  transition: all 0.3s ease;
}

aside.sidebar a:hover,
aside.sidebar a.active {
  background: var(--secondary);
  color: #2f2f1f;
  transform: translateX(4px);
}

/* Header */
header {
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(8px);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
  border-bottom: 3px solid var(--highlight);
  animation: fadeInDown 1s ease;
}

@keyframes fadeInDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

header .top-controls button {
  margin-left: 10px;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: 0.3s;
  background: var(--highlight);
  color: #fff;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

header .top-controls button:hover {
  background: #f9a825;
  transform: scale(1.05);
}

/* Main */
main {
  flex: 1;
  padding: 30px;
  animation: fadeIn 1.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Stats Cards */
.stats-row {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 14px;
  padding: 18px;
  flex: 1;
  min-width: 200px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-left: 6px solid var(--secondary);
  transition: all 0.4s ease;
  backdrop-filter: blur(5px);
}

.stat-card:hover {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 6px 20px rgba(107, 66, 38, 0.25);
}

.stat-card h3 {
  font-size: 1em;
  color: #6b4226;
}

.stat-card .value {
  font-size: 1.8em;
  font-weight: 700;
  color: var(--secondary);
  text-shadow: 0 0 6px rgba(163,193,74,0.5);
}

/* Recent Items */
.recent-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.recent-item {
  background: rgba(255,255,255,0.85);
  padding: 14px 18px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: var(--shadow);
  border-left: 5px solid var(--highlight);
  transition: 0.3s;
}

.recent-item:hover {
  transform: scale(1.03);
  background: #fffbe8;
}

/* Recommendation Section */
#recommendation-section {
  background: rgba(255,255,255,0.92);
  padding: 30px;
  border-radius: 14px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  margin-top: 40px;
  backdrop-filter: blur(6px);
  border-left: 6px solid var(--secondary);
  animation: fadeInUp 1.2s ease;
}

@keyframes fadeInUp {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

#recommendation-section input {
  width: 80%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  transition: 0.3s;
}

#recommendation-section input:focus {
  border-color: var(--secondary);
  box-shadow: 0 0 6px rgba(163,193,74,0.4);
}

#recommendation-section button {
  background: var(--secondary);
  color: #2f2f1f;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}

#recommendation-section button:hover {
  background: #90b33d;
  transform: scale(1.05);
}

/* Dark Mode Styling */
body.dark-mode {
  background: linear-gradient(-45deg, #2b1d0e, #3b2a1a, #4a3925, #2f2212);
  background-size: 400% 400%;
  color: #f3e8d1;
  animation: gradientShift 15s ease infinite;
}

body.dark-mode .stat-card,
body.dark-mode .recent-item,
body.dark-mode header,
body.dark-mode main {
  background: rgba(47, 34, 18, 0.9);
  color: #f3e8d1;
}

body.dark-mode .stat-card .value {
  color: #ffb84d;
}

body.dark-mode aside.sidebar {
  background: rgba(59, 42, 26, 0.95);
}

body.dark-mode aside.sidebar a.active {
  background: #a3c14a;
  color: #1b1a11;
}

/* Responsive */
@media(max-width:900px) {
  aside.sidebar {
    width: 60px;
    padding: 12px;
  }
  aside.sidebar h2 { display: none; }
  main { padding: 20px; }
  .stats-row { flex-direction: column; }
}

/* üåæ Enhanced Grid Layout for Recent Products */
.recent-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 24px;
  list-style: none;
  padding: 0;
  margin: 0;
}

.recent-grid .recent-item {
  background: linear-gradient(145deg, #ffffff, #f9f5e3);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  border: 2px solid #f2e8cf;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.recent-grid .recent-item:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 20px rgba(107, 66, 38, 0.25);
}

.recent-grid .recent-item img {
  width: 100%;
  height: 160px;
  border-radius: 12px;
  object-fit: cover;
  margin-bottom: 12px;
}

.recent-grid .recent-item strong {
  font-size: 1.1em;
  color: #6b4226;
  margin-bottom: 6px;
}

.recent-grid .recent-item small {
  color: #555;
  font-size: 0.9em;
}

/* Category Badge */
.recent-grid .category-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--secondary);
  color: #2f2f1f;
  padding: 4px 10px;
  font-size: 0.8em;
  border-radius: 20px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* Hover glow for category badge */
.recent-grid .recent-item:hover .category-badge {
  background: var(--highlight);
  color: #fffaf0;
}
#recommendation-section {
    display: none !important;
}


  </style>
</head>

<body>
  <aside class="sidebar">
    <div>
      <h2>üåæ Green Fields</h2>
      <nav>
        <a href="farmers.html" class="active">Home</a>
        <a href="profile.html">Profile</a>
        <a href="farmer-history.html">Orders</a>
       <a href="sellers.html">Add Product</a>
<a href="farmer-orders.html"> Received Orders</a>
 <a href="recommendations.html">Recommendations</a>
</nav>
    </div>
    <div><small>&copy; 2025 Green Valley Farm</small></div>
  </aside>

  <div style="flex:1;">
    <header>
      <div>Farmers Dashboard</div>
      <div class="top-controls">
        
        <button id="logoutBtn">Logout</button>
      </div>
    </header>

    <main>

      <h2 style="margin-bottom:20px;">Overview</h2>

      <div class="stats-row">
        <div class="stat-card">
          <h3>Total Products</h3>
          <div class="value" id="totalProducts">0</div>
        </div>
        <div class="stat-card">
          <h3>Active Orders</h3>
          <div class="value" id="activeOrders">0</div>
        </div>
        <div class="stat-card">
          <h3>Total Earnings</h3>
          <div class="value" id="totalEarnings">$0</div>
        </div>
      </div>

      <h2 style="margin:30px 0 15px;">Recent Products</h2>
      <ul class="recent-grid" id="historyList">
        <li style="text-align:center; color:#888;">Loading...</li>
      </ul>


      <section id="recommendation-section" style="margin: 40px auto; text-align: center;">
        <h2>üåæ Crop Recommendation System</h2>
        <p>Select your soil type, season, and region to get AI-based crop suggestions.</p>

        <form id="recommend-form" style="display:flex; flex-direction:column; gap:10px; align-items:center;">
          <input type="text" id="soilType" placeholder="Enter Soil Type (e.g., Loamy, Sandy, Clay)" required />
          <input type="text" id="season" placeholder="Enter Season (e.g., Summer, Rainy, Winter)" required />
          <input type="text" id="region" placeholder="Enter Region (e.g., South, North, West)" required />
          <button type="submit" class="btn">Get Recommendations</button>
        </form>

        <div id="recommendation-output" style="margin-top:20px;">
          <p><strong>Recommended Crops:</strong></p>
          <ul id="crop-list"></ul>
        </div>

        <div id="product-output" style="margin-top:20px;">
          <p><strong>Related Products:</strong></p>
          <ul id="product-list"></ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ================== LOAD PRODUCT HISTORY ==================

    async function loadHistory() {
      try {
        const res = await fetch("http://localhost:5000/my-products", { credentials: "include" });
        if (!res.ok) return console.error("Fetch failed:", res.status);

        const products = await res.json();
        document.getElementById("totalProducts").textContent = products.length;
        document.getElementById("activeOrders").textContent = products.filter(p => p.quantity > 0).length;
        document.getElementById("totalEarnings").textContent =
          "$" + products.reduce((a, p) => a + (p.price || 0), 0);

        const list = document.getElementById("historyList");
        list.innerHTML = "";
        if (!products.length) {
          list.innerHTML = `<li style="text-align:center; color:#888;">No products found.</li>`;
          return;
        }

       products.slice(0, 6).forEach(p => {
  const li = document.createElement("li");
  li.classList.add("recent-item");

  const hasCategory = p.category && p.category.trim() !== "";
  const desc = p.description || "No description available";
  const loc = p.location || "Location not specified";
  const date = p.createdAt ? new Date(p.createdAt).toLocaleDateString() : "Unknown date";

  li.innerHTML = `
    ${hasCategory ? `<span class="category-badge">${p.category}</span>` : ""}
    <img src="${p.image || 'https://via.placeholder.com/250x160?text=No+Image'}" alt="${p.name}">
    <strong>${p.name}</strong>
    <small>üí∞ Price: $${p.price} | üì¶ Quantity: ${p.quantity}</small>
    <small>üìÖ Added on: ${date}</small>

    <p style="font-size:0.9em; margin-top:6px; color:#555;">${desc}</p>
  `;
  list.appendChild(li);
});

        renderChart(products);
      } catch (err) {
        console.error("Error loading products:", err);
      }
    }

    function renderChart(products) {
      const ctx = document.getElementById("productChart");
      const categories = [...new Set(products.map(p => p.category || "Uncategorized"))];
      const counts = categories.map(cat => products.filter(p => p.category === cat).length);

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: categories,
          datasets: [{ label: "Products per Category", data: counts, borderRadius: 6, backgroundColor: "#a3c14a" }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

  

    // ================== LOGOUT ==================
    document.getElementById("logoutBtn").addEventListener("click", () => {
      alert('Logout successful.');
      window.location.href = 'login.html';
    });

    // ================== SIDEBAR TAB SWITCH ==================
    function showTab(id, btn) {
      document.querySelectorAll("aside.sidebar a").forEach(a => a.classList.remove("active"));
      if (btn) btn.classList.add("active");

      document.querySelectorAll("main section").forEach(sec => sec.style.display = "none");
      const selected = document.getElementById(id);
      if (selected) selected.style.display = "block";
      else console.warn(`Section with id "${id}" not found`);
    }

    // ================== AI CROP RECOMMENDATION ==================
    const form = document.getElementById("recommend-form");
    const cropList = document.getElementById("crop-list");
    const productList = document.getElementById("product-list");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const soilType = document.getElementById("soilType").value.trim();
      const season = document.getElementById("season").value.trim();
      const region = document.getElementById("region").value.trim();

      cropList.innerHTML = "<li>‚è≥ Fetching recommendations...</li>";
      productList.innerHTML = "";

      try {
        // üåæ Ask backend for crop suggestions
        const res = await fetch("http://localhost:4000/api/recommend/crop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ soilType, season, region }),
        });

        const data = await res.json();
        const crops = Array.isArray(data.crops) ? data.crops : [];

        if (!crops.length) {
          cropList.innerHTML = "<li>‚ùå No crops found for given inputs.</li>";
          return;
        }

        // ü™¥ Display crop list
        cropList.innerHTML = "";
        for (const crop of crops) {
          const li = document.createElement("li");
          li.textContent = "üåø " + crop;
          cropList.appendChild(li);

          // üß† Get AI Product Recommendations for each crop
          const prodRes = await fetch(`http://localhost:4000/api/recommend/product/${crop}`);
          const prodData = await prodRes.json();

          if (prodData.products && prodData.products.length) {
            const sourceLabel =
              prodData.source === "database"
                ? "üóÑÔ∏è From Database"
                : "ü§ñ From Gemini AI";

            const header = document.createElement("h4");
            header.textContent = `${sourceLabel} ‚Äî Products for ${crop}`;
            productList.appendChild(header);

            // üé® Display products as cards
            prodData.products.forEach((p) => {
              const card = document.createElement("li");
              card.style = `
              background:#fffbe7;
              border-radius:10px;
              padding:10px;
              margin:5px;
              box-shadow:0 2px 8px rgba(0,0,0,0.1);
              list-style:none;
            `;
              card.innerHTML = `
              <strong>üõí ${p.name}</strong><br>
              <small>üí∞ Price: ${p.price || "N/A"}</small>
            `;
              productList.appendChild(card);
            });
          }
        }
      } catch (err) {
        console.error("‚ùå Recommendation Fetch Error:", err);
        cropList.innerHTML = "<li>‚ö†Ô∏è Error fetching recommendations.</li>";
      }
    });

    // ================== LOAD FARMER ORDERS ==================
 // ================== LOAD FARMER ORDERS ==================
async function fetchOrders() {
  try {
    const res = await fetch("/api/farmer/orders", {
  method: "GET",
  credentials: "include"   // ‚úÖ VERY IMPORTANT
})
  .then(res => res.json())
  .then(data => console.log(data))
  .catch(err => console.error(err));

    const data = await res.json();

    const container = document.getElementById("ordersContainer");
    container.innerHTML = "";

    if (!data.success || data.orders.length === 0) {
      container.innerHTML = "<p>No orders received yet.</p>";
      return;
    }

    data.orders.forEach(order => {
      const div = document.createElement("div");
      div.className = "order-card";
      div.innerHTML = `
        <h3>${order.productName}</h3>
        <p><strong>Buyer:</strong> ${order.buyerName}</p>
        <p><strong>Email:</strong> ${order.buyerEmail}</p>
        <p><strong>Phone:</strong> ${order.buyerPhone}</p>
        <p><strong>Quantity:</strong> ${order.quantity}</p>
        <p><strong>Address:</strong> ${order.address}</p>
        <p><strong>Message:</strong> ${order.message || "‚Äî"}</p>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error("Error fetching orders:", err);
  }
}

fetchOrders();





    window.onload = async () => {
      await loadHistory(); // your existing product list
      await fetchOrders();  // new orders list
    };


  </script>
</body>

</html>  