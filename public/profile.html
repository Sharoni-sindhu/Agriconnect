<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Profile | AgriConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f8f3;
      margin: 0;
      padding: 0;
    }

    .profile-container {
      max-width: 750px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(34, 68, 32, 0.13);
      padding: 30px 24px 38px 24px;
    }

    header {
      border-bottom: 1px solid #d1e7dd;
      padding-bottom: 12px;
      margin-bottom: 20px;
      text-align: center;
    }

    header h1 {
      color: #34783a;
    }

    #role-label {
      background: #e5f5e6;
      color: #2a6538;
      display: inline-block;
      padding: 3px 15px;
      border-radius: 15px;
      margin-top: 5px;
      font-size: 1.02em;
    }

    h2 {
      color: #4d6b3e;
      margin-top: 18px;
      margin-bottom: 9px;
    }

    section {
      margin-bottom: 21px;
    }

    .profile-details table {
      width: 100%;
      border-collapse: collapse;
      background: #fafcf8;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 7px;
    }

    .profile-details th,
    .profile-details td {
      text-align: left;
      padding: 7px 8px;
    }

    .profile-details th {
      background: #eaf6ea;
      color: #387c43;
      width: 135px;
      font-weight: 600;
    }

    .profile-details td {
      color: #506450;
    }

    .profile-details tr:not(:last-child) {
      border-bottom: 1px solid #e0e8e0;
    }

    .profile-actions {
      margin-top: 22px;
      text-align: right;
    }

    .action-btn {
      padding: 7px 17px;
      margin: 3px;
      background: #36af53;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s;
    }

    .action-btn:hover {
      background: #29883c;
    }

    button {
      outline: none;
    }

    form input,
    form textarea,
    form select {
      width: 100%;
      padding: 8px 10px;
      margin: 6px 0 14px 0;
      border: 1px solid #c8ecd3;
      border-radius: 6px;
      font-size: 1em;
    }

    form label {
      font-weight: 600;
      color: #2d5733;
    }

    .hidden {
      display: none;
    }

    /* Profile Image Styling */
    .profile-image {
      text-align: center;
      margin-bottom: 18px;
    }

    .profile-image img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #36af53;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    @media (max-width: 800px) {
      .profile-container {
        padding: 10px;
      }

      header h1 {
        font-size: 1.4em;
      }
    }
  </style>
</head>

<body>
  <div class="profile-container">
    <header>
      <h1>Profile Dashboard</h1>
      <p id="role-label">Role: <span id="profile-role">Not set</span></p>
    </header>

    <!-- Profile Form -->
    <section id="profile-form-section">
      <h2>Enter Your Details</h2>

      <div class="profile-image">
        <img id="preview-image"  alt="Profile Image">
      </div>

      <form id="profile-form">
        <label>Upload Profile Image:</label>
        <input type="file" id="input-image" accept="image/*">

        <label>Name:</label>
        <input type="text" id="input-name" required>

        <label>Role:</label>
        <select id="input-role" required>
          <option value="">Select role</option>
          <option value="Farmer">Farmer</option>
          <option value="Buyer">Buyer</option>
          <option value="Both">Both</option>
        </select>

        <label>Location:</label>
        <input type="text" id="input-location">

        <label>Summary:</label>
        <textarea id="input-summary" rows="3"></textarea>

        <label>Products/Interests:</label>
        <input type="text" id="input-products">

        <label>Community/FPO:</label>
        <input type="text" id="input-fpo">

        <label>Certifications:</label>
        <input type="text" id="input-cert">

        <label>Preferred Payment:</label>
        <input type="text" id="input-payment">

        <label>Languages:</label>
        <input type="text" id="input-languages">

        <label>Contact:</label>
        <input type="email" id="input-contact">

        <button type="submit" class="action-btn">Save Profile</button>
      </form>
    </section>

    <!-- Profile Display -->
    <section id="profile-display-section" class="hidden">
      <div class="profile-image">
       <!-- put a default.png inside public/ folder -->
<img id="preview-image" src="default.png" alt="Profile Image">
<img id="display-image" src="default.png" alt="Profile Image">


      <h2>Profile Summary</h2>
      <p id="display-summary"></p>

      <h2>Key Details</h2>
      <div class="profile-details">
        <table>
          <tr>
            <th>Name</th>
            <td id="display-name"></td>
          </tr>
          <tr>
            <th>Location</th>
            <td id="display-location"></td>
          </tr>
          <tr>
            <th>Products/Interests</th>
            <td id="display-products"></td>
          </tr>
          <tr>
            <th>Community/FPO</th>
            <td id="display-fpo"></td>
          </tr>
          <tr>
            <th>Certifications</th>
            <td id="display-cert"></td>
          </tr>
          <tr>
            <th>Preferred Payment</th>
            <td id="display-payment"></td>
          </tr>
          <tr>
            <th>Languages</th>
            <td id="display-languages"></td>
          </tr>
          <tr>
            <th>Contact</th>
            <td id="display-contact"></td>
          </tr>
        </table>
      </div>
      <div class="profile-actions">
        <button id="edit-profile" class="action-btn">Edit Profile</button>
      </div>
    </section>
  </div>

  <script>
    const profileForm = document.getElementById("profile-form");
    const formSection = document.getElementById("profile-form-section");
    const displaySection = document.getElementById("profile-display-section");
    const profileRole = document.getElementById("profile-role");
    const inputImage = document.getElementById("input-image");
    const previewImage = document.getElementById("preview-image");
    const displayImage = document.getElementById("display-image");

    // Preview uploaded image
    inputImage.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    profileForm.addEventListener("submit", function (e) {
  e.preventDefault();

  // Collect values
  const name = document.getElementById("input-name").value;
  const role = document.getElementById("input-role").value;
  const location = document.getElementById("input-location").value;
  const summary = document.getElementById("input-summary").value;
  const products = document.getElementById("input-products").value;
  const fpo = document.getElementById("input-fpo").value;
  const cert = document.getElementById("input-cert").value;
  const payment = document.getElementById("input-payment").value;
  const languages = document.getElementById("input-languages").value;
  const contact = document.getElementById("input-contact").value;
  const image = previewImage.src || "default.png"; // fallback image

  const profileData = { name, role, location, summary, products, fpo, cert, payment, languages, contact, image };

  // Save to localStorage
  localStorage.setItem("userProfile", JSON.stringify(profileData));

  alert("✅ Profile saved successfully!");
  window.location.href = "consumers.html"; // go back to dashboard
});

  const res = await fetch("/api/profile", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(profileData)
});

let data;
try {
  data = await res.json();
} catch (err) {
  console.error("Response not JSON:", err);
  throw new Error("Server did not return JSON");
}

if (res.ok) {
  alert("✅ Profile saved in MongoDB!");
  window.location.href = "farmers.html";
} else {
  alert("❌ Failed: " + (data.error || "Unknown error"));
}

window.addEventListener("DOMContentLoaded", () => {
  const storedProfile = JSON.parse(localStorage.getItem("userProfile")) || {};
  if (storedProfile.name) document.getElementById("input-name").value = storedProfile.name;
  if (storedProfile.role) document.getElementById("input-role").value = storedProfile.role;
  if (storedProfile.location) document.getElementById("input-location").value = storedProfile.location;
  if (storedProfile.summary) document.getElementById("input-summary").value = storedProfile.summary;
  if (storedProfile.products) document.getElementById("input-products").value = storedProfile.products;
  if (storedProfile.fpo) document.getElementById("input-fpo").value = storedProfile.fpo;
  if (storedProfile.cert) document.getElementById("input-cert").value = storedProfile.cert;
  if (storedProfile.payment) document.getElementById("input-payment").value = storedProfile.payment;
  if (storedProfile.languages) document.getElementById("input-languages").value = storedProfile.languages;
  if (storedProfile.contact) document.getElementById("input-contact").value = storedProfile.contact;
  if (storedProfile.image) previewImage.src = storedProfile.image;
});


  </script>
</body>

</html>