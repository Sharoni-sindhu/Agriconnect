<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmers Dashboard | Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #6b4226;
      --secondary: #a3c14a;
      --accent: #fffaf0;
      --surface: #ffffff;
      --gray: #f9f6ef;
      --highlight: #ffb347;
      --shadow: 0 4px 18px rgba(107, 66, 38, 0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--accent);
      color: #3b2f2f;
      display: flex;
      min-height: 100vh;
      transition: 0.3s;
    }

    aside.sidebar {
      width: 260px;
      background: var(--primary);
      color: #fffaf0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 28px;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      box-shadow: var(--shadow);
      transition: 0.3s;
    }

    aside.sidebar h2 {
      color: var(--highlight);
      text-align: center;
      margin-bottom: 32px;
      font-size: 2rem;
    }

    aside.sidebar a {
      display: block;
      padding: 12px 16px;
      color: #fffaf0;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: 0.2s;
    }

    aside.sidebar a:hover,
    aside.sidebar a.active {
      background: var(--secondary);
      color: #2f2f1f;
      transform: scale(1.05);
    }

    header {
      background: var(--surface);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      border-bottom: 3px solid var(--highlight);
      position: sticky;
      top: 0;
      z-index: 10;
      transition: 0.3s;
    }

    main {
      flex: 1;
      margin-left: 260px;
      padding: 32px 48px;
      background: var(--accent);
      transition: 0.3s;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--surface);
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      box-shadow: var(--shadow);
      border-left: 6px solid var(--secondary);
      transition: 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    .chart-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      max-width: 600px;
      margin-bottom: 40px;
      transition: 0.3s;
    }

    .chart-card h2 {
      margin-bottom: 20px;
    }

    .recent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .recent-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .recent-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 6px 20px rgba(107, 66, 38, 0.25);
    }

    .recent-card img {
      width: 100%;
      height: 150px;
      border-radius: 12px;
      object-fit: cover;
      margin-bottom: 12px;
    }

    .recent-card h4 {
      color: #6b4226;
      margin-bottom: 6px;
    }

    .recent-card small {
      color: #777;
    }

    /* Top buttons styling */
    .top-controls button {
      background: var(--secondary);
      color: var(--primary);
      border: none;
      padding: 8px 16px;
      margin-left: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    .top-controls button:hover {
      background: var(--highlight);
      color: var(--surface);
      transform: scale(1.05);
    }

    /* Dark Mode */
    body.dark-mode {
      background: #2c2c2c;
      color: #f2f2f2;
    }

    body.dark-mode header {
      background: #3b3b3b;
      border-bottom-color: #ffb347;
    }

    body.dark-mode aside.sidebar {
      background: #1f1f1f;
      color: #fff;
    }

    body.dark-mode .stat-card,
    body.dark-mode .chart-card,
    body.dark-mode .recent-card {
      background: #3b3b3b;
      color: #f2f2f2;
    }

    @media (max-width: 900px) {
      aside.sidebar {
        width: 200px;
      }

      main {
        margin-left: 200px;
        padding: 24px;
      }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div>
      <h2><br></h2>
      <nav>
        <a href="farmers.html" class="active">Home</a>
        <a href="profile.html">Profile</a>
        <a href="farmer-history.html">Orders</a>
        <a href="sellers.html">Add Product</a>
      </nav>
    </div>
    <div><small>&copy; 2025 Green Valley Farm</small></div>
  </aside>

  <div style="flex:1;">
    <header>
      <div><b>Farmers Dashboard</b></div>
      <div class="top-controls">
        <span id="welcomeText"><b>Welcome, User</b></span>
  
        <button onclick="alert('Logout!'); window.location.href='login.html'">Logout</button>
      </div>
    </header>

    <main>
      <div class="chart-card">
        <h2>Product Distribution</h2>
        <canvas id="productChart" height="200"></canvas>
      </div>

      <h2 style="margin-bottom:20px;">Overview</h2>
      <div class="stats-row">
        <div class="stat-card">
          <h3>Total Products</h3>
          <div class="value" id="totalProducts">0</div>
        </div>
        <div class="stat-card">
          <h3>Active Orders</h3>
          <div class="value" id="activeOrders">0</div>
        </div>
        <div class="stat-card">
          <h3>Total Earnings</h3>
          <div class="value" id="totalEarnings">$0</div>
        </div>
      </div>

      <h2 style="margin:30px 0 15px;">Recent Products</h2>
      <div class="recent-grid" id="historyList">
        <p style="text-align:center; color:#888;">Loading...</p>
      </div>
    </main>

    <!-- Your original JS stays completely unchanged -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = localStorage.getItem("username") || "User";
        document.getElementById("welcomeText").textContent = `Welcome, ${username}`;
      });

      window.onload = loadHistory;

      async function loadUsername() {
        try {
          const res = await fetch("http://localhost:3001/session-user", {
            credentials: "include",
          });

          const data = await res.json();
          console.log("User Data:", data); // ðŸ‘ˆ check console output

          if (data.loggedIn) {
            document.getElementById("welcomeText").textContent = `Welcome, ${data.name}`;
          } else {
            document.getElementById("welcomeText").textContent = "Welcome, Guest";
          }
        } catch (err) {
          console.error("Error loading user:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", loadUsername);

      async function loadHistory() {
        try {
          const res = await fetch("http://localhost:3001/my-products", { credentials: "include" });
          if (!res.ok) return console.error("Fetch failed:", res.status);

          const products = await res.json();
          products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          document.getElementById("totalProducts").textContent = products.length;
          document.getElementById("activeOrders").textContent = products.filter(p => p.quantity > 0).length;
          document.getElementById("totalEarnings").textContent = "$" + products.reduce((a, p) => a + (p.price || 0), 0);

          const container = document.getElementById("historyList");
          container.innerHTML = "";

          if (products.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:#888;">No products found.</p>`;
            return;
          }

          products.slice(0, 6).forEach(p => {
            const card = document.createElement("div");
            card.classList.add("recent-card");
            card.innerHTML = `
              <img src="${p.image || 'https://via.placeholder.com/150'}" alt="${p.name}">
              <h4>${p.name}</h4>
              <p><b>â‚¹${p.price}</b> â€¢ ${p.category || 'Other'}</p>
              <small>Qty: ${p.quantity} | ${new Date(p.createdAt).toLocaleDateString()}</small>
            `;
            container.appendChild(card);
          });

          renderChart(products);
        } catch (err) {
          console.error("Error loading products:", err);
        }
      }

      function renderChart(products) {
        const ctx = document.getElementById("productChart");
        if (!products.length) return;

        const categories = [...new Set(products.map(p => {
          if (!p.category || !p.category.trim()) return "Others"; // handle empty or null
          return p.category.trim(); // remove whitespace
        }))];

        const counts = categories.map(cat =>
          products.filter(p => ((p.category && p.category.trim()) || "Others") === cat).length
        );

        const colors = {
          "fruits": "#ff6384",
          "vegetables": "#36a2eb",
          "grains": "#ffce56",
          "dairy": "#4bc0c0",
          "others": "#9966ff"
        };

        const bgColors = categories.map(c => colors[c.toLowerCase()] || "#a3c14a");

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: categories,
            datasets: [{
              data: counts,
              backgroundColor: bgColors,
              borderWidth: 2,
              hoverOffset: 10
            }]
          },
          options: {
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 15 } }
            },
            cutout: "60%"
          }
        });
      }

      
    </script>
  </div>
</body>

</html>