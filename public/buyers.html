<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buy Products - Green Fields</title>
  <style>
    /* ===== COLOR VARIABLES ===== */
    :root {
  --primary: #1E8562;   /* greenish */
  --secondary: #4ABDAC; /* bluish */
  --accent: #f0f9f5;
  --surface: #ffffff;
  --highlight: #1E8562;
  --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  --text: #333;
  --background: #f0f9f5;
}


    /* ===== GENERAL ===== */
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--accent);
      color: #3b2f2f;
      min-height: 100vh;
    }

    h2 {
      text-align: center;
      margin: 20px 0;
      color: var(--primary);
    }

    /* ===== NAVBAR ===== */
    .navbar {
      background: var(--primary);
      color: var(--surface);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 25px;
      box-shadow: var(--shadow);
    }

    .navbar-brand {
      font-weight: bold;
      font-size: 20px;
      color: var(--secondary);
    }

    .navbar-links {
      list-style: none;
      display: flex;
      gap: 25px;
      margin: 0;
    }

    .navbar-links a {
      text-decoration: none;
      color: var(--surface);
      font-weight: 500;
      transition: 0.2s;
    }

    .navbar-links a:hover {
      color: var(--secondary);
    }

    /* ===== SEARCH BOX ===== */
    #searchBox {
      padding: 10px;
      width: 60%;
      max-width: 400px;
      border-radius: 8px;
      border: 1px solid #ccc;
      transition: 0.2s;
    }

    #searchBox:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 8px rgba(163, 193, 74, 0.4);
    }

    /* ===== PRODUCT GRID ===== */
    .product-container,
    #productList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 25px;
      padding: 30px 50px;
      justify-items: center;
    }

    .product-card,
    .product {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
      width: 100%;
      max-width: 280px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .product-card:hover,
    .product:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(107, 66, 38, 0.25);
    }

    .product h3 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    .product p {
      margin: 5px 0;
      color: #444;
    }

    .product img {
      max-width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: 12px;
      margin: 10px 0;
    }

    /* ===== BUY BUTTON ===== */
    .buy-btn {
      background: linear-gradient(135deg, var(--secondary), #c7e58f);
      color: var(--primary);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    .buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      background: linear-gradient(135deg, #a3c14a, #c7e58f);
      color: var(--primary);
    }

    .buy-btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    /* ===== SELLER MODAL ===== */
    .popup,
    #sellerModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .popup-content,
    #sellerModalContent {
      background: var(--surface);
      padding: 25px;
      border-radius: 16px;
      width: 350px;
      max-width: 90%;
      text-align: left;
      box-shadow: var(--shadow);
    }

    .close {
      float: right;
      font-size: 22px;
      cursor: pointer;
    }

    /* ===== CONTACT SELLER BUTTONS ===== */
    #contactButtons .contact-seller {
      display: inline-block;
      margin: 5px 5px 5px 0;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 600;
      text-decoration: none;
      color: var(--surface);
      transition: all 0.2s ease-in-out;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    #contactButtons .email-btn {
      background: linear-gradient(135deg, #4fc3f7, #29b6f6);
    }

    #contactButtons .call-btn {
      background: linear-gradient(135deg, #81c784, #a5d6a7);
    }

    #contactButtons .contact-seller:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      opacity: 0.95;
    }

    #contactButtons .contact-seller:active {
      transform: translateY(0);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    /* ===== FORM INSIDE POPUP ===== */
    .popup-content form {
      display: flex;
      flex-direction: column;
    }

    .popup-content input {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <!-- ===== NAVBAR ===== -->
  <nav class="navbar">
    <div class="navbar-brand">üåæ Green Fields</div>
    <ul class="navbar-links">
      <li><a id="homeLink" href="#">Home</a></li>
      <li><a href="orders.html">My Orders</a></li>
      <li><a href="logout">Logout</a></li>
    </ul>
  </nav>

  <h2>Available Products</h2>

  <!-- ===== SEARCH BOX ===== -->
  <div style="text-align:center; margin:20px;">
    <input type="text" id="searchBox" placeholder="Search products...">
  </div>

  <!-- ===== PRODUCT LIST ===== -->
  <main>
    <div class="product-container" id="productList"></div>
  </main>

  <!-- ===== SELLER MODAL ===== -->
  <div id="sellerModal">
    <div id="sellerModalContent">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Seller Info</h2>
      <div id="sellerInfo"></div>
      <div id="contactButtons" style="margin-top:15px;"></div>
    </div>
  </div>

  <!-- ===== JAVASCRIPT ===== -->
  <script>
    async function saveOrder(productId, productName, sellerName, sellerEmail, sellerPhone, action) {
      try {
        const res = await fetch("/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productName, sellerName, sellerEmail, sellerPhone, action })
        });
        const data = await res.json();
        if (res.ok) console.log("‚úÖ Order saved:", data);
        else console.error("‚ùå Failed to save order:", data.error);
      } catch (err) {
        console.error("‚ùå Error in saveOrder:", err);
      }
    }

    async function loadProducts() {
      try {
        const res = await fetch("/products");
        const products = await res.json();
        const list = document.getElementById("productList");
        list.innerHTML = "";

        if (!products.length) {
          list.innerHTML = "<p style='text-align:center; color:#888;'>No products available right now.</p>";
          return;
        }

        products.forEach(p => {
          const div = document.createElement("div");
          div.className = "product";
          div.innerHTML = `
          <h3>${p.name}</h3>
          <p><strong>Price:</strong> ‚Çπ${p.price}</p>
          <p><strong>Quantity:</strong> ${p.quantity}</p>
          <p><strong>Description:</strong> ${p.description || "N/A"}</p>
          ${p.image ? `<img src="${p.image}" alt="Product">` : ""}
          <button class="buy-btn"
            data-id="${p._id || p.id}"
            data-name="${p.name}"
            data-sellername="${p.sellerName || 'Unknown'}"
            data-selleremail="${p.sellerEmail || 'Not Provided'}"
            data-sellerphone="${p.sellerPhone || 'Not Provided'}">
            Contact Seller
          </button>
        `;
          list.appendChild(div);
        });

        // Function to save order to localStorage
        function saveOrderToLocalStorage(order) {
          // Get current orders from localStorage or create empty array
          let orders = JSON.parse(localStorage.getItem("orders")) || [];

          // Add new order
          orders.push(order);

          // Save back to localStorage
          localStorage.setItem("orders", JSON.stringify(orders));
        }

        // Attach to existing "Contact Seller" buttons
        document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll(".buy-btn").forEach(btn => {
            btn.addEventListener("click", () => {
              const order = {
                productName: btn.getAttribute("data-name"),
                price: parseFloat(btn.getAttribute("data-price")) || 0,
                category: btn.getAttribute("data-category") || "Other",
                image: btn.getAttribute("data-image") || "",
                date: new Date().toISOString()
              };
              saveOrderToLocalStorage(order);
            });
          });
        });

        document.querySelectorAll(".buy-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const seller = {
              sellerName: btn.getAttribute("data-sellername"),
              sellerEmail: btn.getAttribute("data-selleremail"),
              sellerPhone: btn.getAttribute("data-sellerphone"),
              name: btn.getAttribute("data-name"),
              id: btn.getAttribute("data-id")
            };
            showSeller(seller);
          });
        });
      } catch (err) {
        console.error("Error loading products:", err);
      }
    }

    function showSeller(product) {
      const info = `
      <strong>Name:</strong> ${product.sellerName}<br>
      <strong>Email:</strong> ${product.sellerEmail}<br>
      <strong>Phone:</strong> ${product.sellerPhone}
    `;
      document.getElementById("sellerInfo").innerHTML = info;

      const buttons = `
      <a href="mailto:${product.sellerEmail}" class="contact-seller email-btn"
         onclick="saveOrder('${product.id}','${product.name}','${product.sellerName}','${product.sellerEmail}','${product.sellerPhone}','Email')">
         ‚úâÔ∏è Email Seller
      </a>
      <a href="tel:${product.sellerPhone}" class="contact-seller call-btn"
         onclick="saveOrder('${product.id}','${product.name}','${product.sellerName}','${product.sellerEmail}','${product.sellerPhone}','Call')">
         üìû Call Seller
      </a>
    `;
      document.getElementById("contactButtons").innerHTML = buttons;
      document.getElementById("sellerModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("sellerModal").style.display = "none";
    }

    // Click outside modal closes it
    window.onclick = e => {
      const modal = document.getElementById("sellerModal");
      if (e.target === modal) modal.style.display = "none";
    };

    // Search filter
    document.getElementById("searchBox").addEventListener("input", e => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll(".product").forEach(p => {
        p.style.display = p.textContent.toLowerCase().includes(query) ? "" : "none";
      });
    });

    // Set Home link based on user role
    fetch('/api/user')
      .then(async res => {
        if (!res.ok) throw new Error("Unauthorized");
        const user = await res.json();
        const homeLink = document.getElementById('homeLink');
        const role = user.role?.toLowerCase();

        if (role === "seller") homeLink.href = "farmers.html";
        else homeLink.href = "consumers.html";

        homeLink.addEventListener('click', e => {
          e.preventDefault();
          window.location.href = homeLink.href;
        });
      })
      .catch(err => {
        console.error("Error fetching user:", err);
        window.location.href = "login.html";
      });

    loadProducts();
  </script>
</body>

</html>